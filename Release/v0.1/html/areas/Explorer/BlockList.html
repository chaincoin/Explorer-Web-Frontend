<div class="BlocksTable center" >
    <div class="panel panel-default">

        <div class="panel-heading">Blocks</div>

        <div class="panel-body">

            <div class="BlocksTable-content">
                <div class="center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            <li class="page-item pagination-previous">
                                <a class="page-link" href="#">Previous</a>
                            </li>
                            <li class="page-item pagination-next">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>

                <div class="row header">
                    <div class="col-lg-1 block-col">
                        Block
                    </div>

                    <div class="col-lg-5 hash-col ellipsis">
                        Hash
                    </div>

                    <div class="col-lg-1 recipients-col">
                        Recipients
                    </div>

                    <div class="col-lg-2 amount-col">
                        Amount (CHC)
                    </div>
                    <div class="col-lg-2 timestamp-col">
                        Timestamp
                    </div>

                </div>

                <div class="rows">

                </div>


                <div class="center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            <li class="page-item pagination-previous">
                                <a class="page-link" href="#">Previous</a>
                            </li>
                            <li class="page-item pagination-next">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>

            <div class="loader-container">
                <div class="loader">

                </div>
            </div>
        </div>
    </div>

</div>

<script>
    $(function () {

        var loaded = false;


        $("body").on("blockCount", function (event, getBlockCount) {
            blockCount = getBlockCount;
        });

        $(".BlocksTable").on("showArea", function () {
            
            if (blockCount == null)
            {
                var promise = jQuery.Deferred();
                $("body").trigger("getBlockCount",[promise]);

                promise.then(function(getBlockCount){
                    blockCount = getBlockCount;
                    BlocksTableLoadBlock(blockCount);
                });
            }
            else 
            {
                BlocksTableLoadBlock(blockCount);
            }
        });




        var blockCount = null;
        var blockTableEl = $(".BlocksTable");
        var rowUiTemplate = blockTableEl.find(".header").clone().removeClass("header");
        var rowsUi = blockTableEl.find(".rows");



        var currentBlockId = 0;
        var blockTableRowsPerPage = 20;

        var blockTablePaginationEl = $(".BlocksTable .pagination");
        var blockTablePaginationNextEl = blockTablePaginationEl.find(".pagination-next");
        blockTablePaginationNextEl.click(function () {

            BlocksTableLoadBlock(currentBlockId - blockTableRowsPerPage);
            return false;
        });

        var blockTablePaginationPreviousEl = blockTablePaginationEl.find(".pagination-previous");
        blockTablePaginationPreviousEl.click(function () {

            BlocksTableLoadBlock(currentBlockId + blockTableRowsPerPage);
            return false;
        });



        var BlocksTableLoadBlock = function (startBlockId) {

            blockTableEl.addClass("loading");
            var rowPromises = [];




            for (var i = 0; i < blockTableRowsPerPage; i++) {
                rowPromises.push(getBlock(startBlockId - i));
            }

            $.when.apply($, rowPromises).then(function () {

                rowsUi.empty();
                for (var i = 0; i < arguments.length; i++) {
                    var rowUi = rowUiTemplate.clone().appendTo(rowsUi);

                    rowUi.addClass("row-striped");

                    var anchorEl = $('<a href="#Explorer/Block/' + arguments[i].hash + '" />');

                    rowUi.find(".block-col").text("");
                    var blockAnchorEl = anchorEl.clone().appendTo(rowUi.find(".block-col"));
                    blockAnchorEl.text(arguments[i].height);

                    rowUi.find(".hash-col").text("");
                    var hashAnchorEl = anchorEl.clone().appendTo(rowUi.find(".hash-col"));
                    hashAnchorEl.text(arguments[i].hash);

                    var recipientCount = 0;
                    var blockValue = 0;

                    arguments[i].transactions.forEach(function (transaction) {


                        transaction.vout.forEach(function (vout) {
                            if (vout.value != 0) recipientCount++;
                            blockValue = blockValue + vout.value;
                        });
                    });

                    rowUi.find(".recipients-col").text(recipientCount);
                    rowUi.find(".amount-col").text(blockValue);


                    var timestamp = new Date((arguments[i].time * 1000));
                    rowUi.find(".timestamp-col").text(timestamp.toLocaleTimeString() + " " + timestamp.toLocaleDateString());
                    currentBlockId = startBlockId;
                }
            }).always(function () {
                blockTableEl.removeClass("loading");
            });
        };

    });
</script>