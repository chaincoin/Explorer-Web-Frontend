<div class="MasternodeDetails">


    <div class="card masternode-details-card">
        <div class="card-header">
            <div class="row">
                <div class="col-md-11">
                    Output:
                    <span class="masternode-output"></span>
                </div>

                <div class="col-md-1 menu-col">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown"
                            data-boundary="viewport" aria-haspopup="true" aria-expanded="false">Menu</button>
                        <div class="dropdown-menu">
                            <a class="dropdown-item view-address" href="#">View Address</a>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item add-to-my-masternodes">Add To My Masternodes</button>
                            <button class="dropdown-item remove-from-my-masternodes">Remove From My Masternodes</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="card-body">


            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active masternodeDetailsTab" data-toggle="tab" href="#masternodeDetailsTabData"
                        role="tab" aria-selected="true">Details</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link masternodeGraphTab" data-toggle="tab" href="#masternodeGraphTabData" role="tab"
                        aria-selected="false">Graph</a>
                </li>
            </ul>

            <div class="tab-content">

                <div class="tab-pane fade show active" id="masternodeDetailsTabData" role="tabpanel">
                    <div class="row">
                        <div class="col-xl-12">
                            <div>
                                Payee
                            </div>
                            <div class="masternode-payee">

                            </div>
                        </div>

                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div>
                                Status
                            </div>
                            <div class="masternode-status">

                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div>
                                Address
                            </div>
                            <div class="masternode-address">

                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div>
                                Active Seconds
                            </div>
                            <div class="masternode-activeseconds">

                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div>
                                Last Seen
                            </div>
                            <div class="masternode-lastseen">

                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div>
                                Daemon Version
                            </div>
                            <div class="masternode-daemonversion">

                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div>
                                Last Paid Block
                            </div>
                            <div class="masternode-lastpaidblock">

                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div>
                                Last Paid Time
                            </div>
                            <div class="masternode-lastpaidtime">

                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-3 col-md-4 col-sm-5">
                            <div>
                                Sentinel Version
                            </div>
                            <div class="masternode-sentinelversion">

                            </div>
                        </div>

                    </div>

                </div>

                <div class="tab-pane fade" id="masternodeGraphTabData" role="tabpanel">
                    <div class="form-group">
                        <label>Unit:</label>
                        <select class="form-control mnPayoutsGraphUnit">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected="selected">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value:</label>
                        <select class="form-control mnPayoutsGraphValue">
                            <option value="sum" selected="selected">CHC</option>
                            <option value="count">Count</option>
                        </select>
                    </div>
                    <canvas class="mnPayoutsGraph"></canvas>
                </div>
            </div>





        </div>
    </div>


    <div class="card masternode-events-card">
        <div class="card-header">
            Events
        </div>
        <div class="card-body">
            <div class="center">
                <nav aria-label="Page navigation example">
                    <ul class="pagination">
                        <li class="page-item pagination-start">
                            <a class="page-link" href="#">&lt;&lt;</a>
                        </li>
                        <li class="page-item pagination-next">
                            <a class="page-link" href="#">&lt;</a>
                        </li>
                        <li class="page-item pagination-previous">
                            <a class="page-link" href="#">&gt;</a>
                        </li>
                        <li class="page-item pagination-end">
                            <a class="page-link" href="#">&gt;&gt;</a>
                        </li>
                    </ul>
                </nav>
            </div>


            <div class="row header">

                <div class="col-lg-3 timestamp-col">
                    Timestamp
                </div>

                <div class="col-lg-3 eventType-col">
                    Event
                </div>

                <div class="col-lg-6 info-col">
                    Info
                </div>
            </div>

            <div class="rows">

            </div>


            <div class="center">
                <nav aria-label="Page navigation example">
                    <ul class="pagination">
                        <li class="page-item pagination-start">
                            <a class="page-link" href="#">&lt;&lt;</a>
                        </li>
                        <li class="page-item pagination-next">
                            <a class="page-link" href="#">&lt;</a>
                        </li>
                        <li class="page-item pagination-previous">
                            <a class="page-link" href="#">&gt;</a>
                        </li>
                        <li class="page-item pagination-end">
                            <a class="page-link" href="#">&gt;&gt;</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>


    <div class="card masternode-notifications-card">
        <div class="card-header">
            Notifications
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-sm-4">
                    Enabled Push Notification
                </div>
                <div class="col-sm-4">
                    <input type="checkbox" class="push-notification-enabled">
                </div>
            </div>

            <div class="row">
                <div class="col-sm-4">
                    Status Change Notification
                </div>
                <div class="col-sm-4">
                    <input type="checkbox" class="masternode-status-change-notification">
                </div>
            </div>
        </div>
    </div>





</div>
<script>
    //block details 
    $(function () {

        var _output = null;
        var _masternode = null;
        $(".MasternodeDetails").on("showArea", function (event, output) {
            loadMasternode(output);
            masternodeDetailsTabEl.click();
            debugger;
        });


        var masternodeDetailsEl = $(".MasternodeDetails");
        var masternodeDetailsCardEl = masternodeDetailsEl.find(".masternode-details-card");

        var masternodeDetailsTabEl = masternodeDetailsEl.find(".masternodeDetailsTab");

        var masternodeOutputEl = masternodeDetailsCardEl.find(".masternode-output");
        var masternodePayeeEl = masternodeDetailsCardEl.find(".masternode-payee");
        var masternodeStatusEl = masternodeDetailsCardEl.find(".masternode-status");
        var masternodeAddressEl = masternodeDetailsCardEl.find(".masternode-address");
        var masternodeActiveSecondsEl = masternodeDetailsCardEl.find(".masternode-activeseconds");
        var masternodeLastSeenEl = masternodeDetailsCardEl.find(".masternode-lastseen");
        var masternodeDaemonVersion = masternodeDetailsCardEl.find(".masternode-daemonversion");
        var masternodeLastPaidBlockEl = masternodeDetailsCardEl.find(".masternode-lastpaidblock");
        var masternodeLastPaidTimeEl = masternodeDetailsCardEl.find(".masternode-lastpaidtime");
        var masternodeSentinelVersionEl = masternodeDetailsCardEl.find(".masternode-sentinelversion");


        var menuButtonEl = masternodeDetailsCardEl.find(".card-header .menu-col .dropdown-toggle");
        var viewAddressEl = masternodeDetailsCardEl.find(".card-header .menu-col .view-address");
        var addMyMasternodeEl = masternodeDetailsCardEl.find(".card-header .menu-col .add-to-my-masternodes");
        var removeMyMasternodeEl = masternodeDetailsCardEl.find(".card-header .menu-col .remove-from-my-masternodes");






        addMyMasternodeEl.click(function () {
            var name = prompt("Please enter a name for the masternode");
            if (name == null) return;

            sendWalletWorkerRequest({
                op: "createMasternode",
                name: name,
                output: _output
            });
            return;
        });


        removeMyMasternodeEl.click(function () {
            if (confirm("Are you sure?") == false) return;

            sendWalletWorkerRequest({
                op: "deleteMasternode",
                output: _output
            });
            return;
        });


        menuButtonEl.click(function () {

            sendWalletWorkerRequest({
                op: "getMasternode",
                output: _output
            }).then(function (response) {

                if (response.data != null) {
                    addMyMasternodeEl.addClass("disabled");
                    removeMyMasternodeEl.removeClass("disabled");
                }
                else {
                    addMyMasternodeEl.removeClass("disabled");
                    removeMyMasternodeEl.addClass("disabled");
                }
            });

        });


        var loadMasternode = function (output) {

            _output = output;
            _masternode = null;

            masternodeOutputEl.text("");
            masternodePayeeEl.text("");
            masternodeStatusEl.text("");
            masternodeAddressEl.text("");
            masternodeActiveSecondsEl.text("");
            masternodeLastSeenEl.text("");
            masternodeDaemonVersion.text("");
            masternodeLastPaidBlockEl.text("");
            masternodeLastPaidTimeEl.text("");
            masternodeSentinelVersionEl.text("");


            var request = {
                op: "getMasternode",
                output:output,
                extended: true
            }

            sendRequest(request).then(function (masternode) {

                _masternode = masternode;

                masternodeOutputEl.text(output);

                var anchorEl = $('<a href="#Explorer/Address/' + masternode.payee + '" />');
                anchorEl.text(masternode.payee);
                masternodePayeeEl.append(anchorEl);

                masternodeStatusEl.text(masternode.status);
                masternodeAddressEl.text(masternode.address);
                masternodeActiveSecondsEl.text(masternode.activeseconds);

                var lastseenTimestamp = new Date(masternode.lastseen * 1000);
                masternodeLastSeenEl.text(lastseenTimestamp.toLocaleTimeString() + " " + lastseenTimestamp.toLocaleDateString());


                masternodeDaemonVersion.text(masternode.daemonversion);
                masternodeLastPaidBlockEl.text(masternode.lastpaidblock);

                var lastpaidtimeTimestamp = new Date(masternode.lastpaidtime * 1000);
                masternodeLastPaidTimeEl.text(lastpaidtimeTimestamp.toLocaleTimeString() + " " + lastpaidtimeTimestamp.toLocaleDateString());

                masternodeSentinelVersionEl.text(masternode.sentinelversion);



                viewAddressEl.attr("href", "#Explorer/address/" + masternode.payee);


                LoadMnEventItems(_masternode.eventCount);

            });



        }


        var _currentMnEventPos = null;
        var _mnEventsPerPage = 20;
        var mnEventCardEl = masternodeDetailsEl.find(".masternode-events-card");
        var mnEventRowTemplateEl = mnEventCardEl.find(".header").removeClass("header");
        var mnEventRowsEl = mnEventCardEl.find(".rows");

        
        var mnEventListPaginationEl = mnEventCardEl.find(".pagination");

        var mnEventListStartEl = mnEventListPaginationEl.find(".pagination-start");
        mnEventListStartEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            LoadAddressTxInfo(_address.txCount);
            return false;
        });

        var mnEventListNextEl = mnEventListPaginationEl.find(".pagination-next");
        mnEventListNextEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            LoadAddressTxInfo(_currentTransactionPos + _transactionPerPage);
            return false;
        });

        var mnEventListPreviousEl = mnEventListPaginationEl.find(".pagination-previous");
        mnEventListPreviousEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            LoadAddressTxInfo(_currentTransactionPos - _transactionPerPage);
            return false;
        });

        var mnEventListEndEl = mnEventListPaginationEl.find(".pagination-end");
        mnEventListEndEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            LoadAddressTxInfo(_masternode.eventCount < _transactionPerPage ? _masternode.eventCount : _transactionPerPage);
            return false;
        });


        var processPaginationControls = function () {

            if (_currentMnEventPos == _masternode.eventCount) {
                mnEventListStartEl.children().addClass("paginationDisabled");
                mnEventListNextEl.children().addClass("paginationDisabled");
            }
            else {
                mnEventListStartEl.children().removeClass("paginationDisabled");
                mnEventListNextEl.children().removeClass("paginationDisabled");
            }

            if (_currentMnEventPos <= _mnEventsPerPage) {
                mnEventListPreviousEl.children().addClass("paginationDisabled");
                mnEventListEndEl.children().addClass("paginationDisabled");
            }
            else {
                mnEventListPreviousEl.children().removeClass("paginationDisabled");
                mnEventListEndEl.children().removeClass("paginationDisabled");
            }
        };


        var LoadMnEventItems = function (pos) {

            sendRequest({
                op: "getMasternodeEvents",
                output: _output,
                pos: pos,
                pageSize: pos < _mnEventsPerPage ? pos : _mnEventsPerPage
            }).then(function (mnEvents) {

                mnEventRowsEl.empty();

                for (var i = 0; i < mnEvents.length; i++) {
                    var mnEventRowEl = mnEventRowTemplateEl.clone().appendTo(mnEventRowsEl);

                    var timestamp = new Date(mnEvents[i].time);
                    mnEventRowEl.find(".timestamp-col").text(timestamp.toLocaleTimeString() + " " + timestamp.toLocaleDateString());


                    mnEventRowEl.find(".eventType-col").text(mnEvents[i].event);

                    if (mnEvents[i].event == "changedMasternode")
                    {
                        mnEventRowEl.find(".info-col").text("Status changed from " + mnEvents[i].oldStatus + " to " + mnEvents[i].newStatus);
                    }

                    

                }


                _currentMnEventPos = pos;
                processPaginationControls();
            }).always(function () {

            });
        };



        var masternodeGraphTabEl = masternodeDetailsEl.find(".masternodeGraphTab");

        var masternodeGraphTabData = masternodeDetailsEl.find("#masternodeGraphTabData");
        var mnPayoutsGraphUnitEl = masternodeGraphTabData.find(".mnPayoutsGraphUnit");
        var mnPayoutsGraphValueEl = masternodeGraphTabData.find(".mnPayoutsGraphValue");
        var mnPayoutsGraphEl = masternodeGraphTabData.find(".mnPayoutsGraph");


        var masternodeGraph = null;

        var color = Chart.helpers.color;
        var config = {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Masternode',
                    backgroundColor: color("rgb(255, 99, 132)").alpha(0.5).rgbString(),
                    borderColor: "rgb(255, 99, 132)",
                    fill: false,
                    data: [],
                }]
            },
            options: {
                title: {
                    text: 'Maternode Payouts'
                },
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'week'
                        }
                    }],
                    yAxes: [{
                        scaleLabel: {
                            display: true,
                            labelString: 'Payouts'
                        }
                    }]
                },
            }
        };

        masternodeGraphTabEl.click(function () {
            loadGraph();
        });

        mnPayoutsGraphUnitEl.change(function () {
            loadGraph();
        });

        mnPayoutsGraphValueEl.change(function () {
            loadGraph();
        });




        var loadGraph = function () {


            if (mnPayoutsGraphUnitEl.val() == "daily") config.options.scales.xAxes[0].time.unit = "day";
            if (mnPayoutsGraphUnitEl.val() == "weekly") config.options.scales.xAxes[0].time.unit = "week";
            if (mnPayoutsGraphUnitEl.val() == "monthly") config.options.scales.xAxes[0].time.unit = "month";
            if (mnPayoutsGraphUnitEl.val() == "yearly") config.options.scales.xAxes[0].time.unit = "year";

            sendRequest({
                op: "getPayoutStats",
                address: _masternode.payee,
                type: "masternode",
                unit: mnPayoutsGraphUnitEl.val()
            }).then(function (stats) {


                config.data.datasets[0].data = [];
                var lastDate = null;
                for (var i = 0; i < stats.length; i++) {
                    var stat = stats[i];
                    var date = null;


                    if (mnPayoutsGraphUnitEl.val() == "daily") date = new Date(stat._id.year, stat._id.month - 1, stat._id.day);
                    if (mnPayoutsGraphUnitEl.val() == "weekly") {
                        date = new Date(stat._id.year, 0, 1);
                        date.setDate(stat._id.week * 7);
                    }
                    if (mnPayoutsGraphUnitEl.val() == "monthly") date = new Date(stat._id.year, stat._id.month - 1, 1);
                    if (mnPayoutsGraphUnitEl.val() == "yearly") date = new Date(stat._id.year, 0, 1);

                    if (lastDate != null) {
                        var current = new Date(lastDate.getTime());

                        if (mnPayoutsGraphUnitEl.val() == "daily") current.setDate(current.getDate() + 1);
                        if (mnPayoutsGraphUnitEl.val() == "weekly") current.setDate(current.getDate() + 7);
                        if (mnPayoutsGraphUnitEl.val() == "monthly") current.setMonth(current.getMonth() + 1);
                        if (mnPayoutsGraphUnitEl.val() == "yearly") current.setFullYear(current.getFullYear() + 1);




                        while (current < date) {
                            config.data.datasets[0].data.push({
                                x: current,
                                y: 0
                            });

                            current = new Date(current.getTime());
                            if (mnPayoutsGraphUnitEl.val() == "daily") current.setDate(current.getDate() + 1);
                            if (mnPayoutsGraphUnitEl.val() == "weekly") current.setDate(current.getDate() + 7);
                            if (mnPayoutsGraphUnitEl.val() == "monthly") current.setMonth(current.getMonth() + 1);
                            if (mnPayoutsGraphUnitEl.val() == "yearly") current.setFullYear(current.getFullYear() + 1);
                        }
                    }

                    config.data.datasets[0].data.push({
                        x: date,
                        y: mnPayoutsGraphValueEl.val() == "sum" ? stat.value : stat.count
                    });

                    lastDate = date;
                }



                if (masternodeGraph == null) {
                    var ctx = mnPayoutsGraphEl[0].getContext('2d');
                    masternodeGraph = new Chart(ctx, config);
                }
                else {
                    masternodeGraph.update();
                }


            });
        }


    });




    $(function () {


        var _output = null;

        var load = function () {

            if (_output == null) return;
            $.get(location.protocol + "//notifications" + chaincoinApiDomain + "/isMasternodeSubscription?firebaseId=" + encodeURI(deviceToken) + "&masternodeOutpoint=" + _output, function (data) {
                masternodeStatusChangeNotificationEl.prop("checked", data);
            });
        }

        var masternodeDetailsEl = $(".MasternodeDetails");
        var masternodeNotificationsCardEl = masternodeDetailsEl.find(".masternode-notifications-card");
        var pushNotificationEnabledEl = masternodeNotificationsCardEl.find(".push-notification-enabled");
        var masternodeStatusChangeNotificationEl = masternodeNotificationsCardEl.find(".masternode-status-change-notification");


        $("body").on("PushedNotificationEnabled", function () {
            masternodeStatusChangeNotificationEl.attr("disabled", false);
            load();
        });
        $("body").on("PushedNotificationDisabled", function () {
            masternodeStatusChangeNotificationEl.attr("disabled", true);
        });

        masternodeDetailsEl.on("showArea", function (event, output) {
            _output = output;
            if (deviceToken != null) load();
        });


        setupEnabledPushNotificationCheckbox(pushNotificationEnabledEl);

        if (deviceToken == null) masternodeStatusChangeNotificationEl.attr("disabled", true);

        masternodeStatusChangeNotificationEl.change(function () {
            if (masternodeStatusChangeNotificationEl.prop("checked")) {
                $.get(location.protocol + "//notifications" + chaincoinApiDomain + "/saveMasternodeSubscription?firebaseId=" + encodeURI(deviceToken) + "&masternodeOutpoint=" + _output)
                    .done(function (data) {

                    })
                    .fail(function () {
                        alert("an error occurred");
                        masternodeStatusChangeNotificationEl.prop("checked", false);
                    });
            }
            else {
                $.get(location.protocol + "//notifications" + chaincoinApiDomain + "/saveMasternodeSubscription?firebaseId=" + encodeURI(deviceToken) + "&masternodeOutpoint=" + _output)
                    .done(function (data) {

                    })
                    .fail(function () {
                        alert("an error occurred");
                        masternodeStatusChangeNotificationEl.prop("checked", true);
                    });
            }
        });


    });

</script>


<style>
    .block-json-link {
        float: right;
        font-size: 20px;
    }
</style>