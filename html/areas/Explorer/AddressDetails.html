<div class="AddressDetails" >


    <div class="card">
        <div class="card-header">
            
            <div class="row">
                <div class="col-md-11">
                    Address:
                    <span class="address-address"></span>
                </div>
            
                <div class="col-md-1 menu-col">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" data-boundary="viewport" aria-haspopup="true" aria-expanded="false">Menu</button>
                        <div class="dropdown-menu">
                        <button class="dropdown-item export-address" href="#">Export</button>
                        <div class="dropdown-divider"></div>
                        <button class="dropdown-item add-to-my-addresses">Add To My Addresses</button>
                        <button class="dropdown-item remove-from-my-addresses">Remove From My Addresses</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-sm-4">
                    <div>
                        Total Sent (CHC)
                    </div>
                    <div class="address-sent">

                    </div>
                </div>

                <div class="col-sm-4">
                    <div>
                        Total Received (CHC)
                    </div>
                    <div class="address-received">

                    </div>
                </div>
                <div class="col-sm-4">
                    <div>
                        Balance (CHC)
                    </div>
                    <div class="address-balance">

                    </div>
                </div>
                

            </div>
        </div>
    </div>

    <div class="card TransactionList">
        <div class="card-header">
            Transactions
        </div>
        <div class="card-body">
            <div class="center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            <li class="page-item pagination-start">
                                <a class="page-link" href="#">&lt;&lt;</a>
                            </li>
                            <li class="page-item pagination-next">
                                <a class="page-link" href="#">&lt;</a>
                            </li>
                            <li class="page-item pagination-previous">
                                <a class="page-link" href="#">&gt;</a>
                            </li>
                            <li class="page-item pagination-end">
                                <a class="page-link" href="#">&gt;&gt;</a>
                            </li>
                        </ul>
                    </nav>
                </div>
    
    
                <div class="row header">
    
                    <div class="col-lg-3 timestamp-col">
                        Timestamp
                    </div>
    
                    <div class="col-lg-7 hash-col">
                        Hash
                    </div>
    
                    <div class="col-lg-2 amount-col">
                        Amount (CHC)
                    </div>
                </div>
    
                <div class="rows">
    
                </div>
    
    
                <div class="center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            <li class="page-item pagination-start">
                                <a class="page-link" href="#">&lt;&lt;</a>
                            </li>
                            <li class="page-item pagination-next">
                                <a class="page-link" href="#">&lt;</a>
                            </li>
                            <li class="page-item pagination-previous">
                                <a class="page-link" href="#">&gt;</a>
                            </li>
                            <li class="page-item pagination-end">
                                <a class="page-link" href="#">&gt;&gt;</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    $(function(){
        $(".AddressDetails").on("showArea", function (event, addressId) {
            loadAddress(addressId);
            debugger;
        });

        var _addressId = null;
        var _address = null;
        var _currentTransactionPos = null;
        var _transactionPerPage = 20;



        var addressDetailsEl = $(".AddressDetails");
        var addressEl = addressDetailsEl.find(".address-address");
        var sentEl = addressDetailsEl.find(".address-sent");
        var receivedEl = addressDetailsEl.find(".address-received");
        var balanceEl = addressDetailsEl.find(".address-balance");

        var transactionListEl = addressDetailsEl.find(".TransactionList");
        var transactionRowTemplateEl = addressDetailsEl.find(".header").removeClass("header");
        var transactionRowsEl = addressDetailsEl.find(".rows");


        var menuButtonEl = addressDetailsEl.find(".card-header .menu-col .dropdown-toggle");
        var exportAddressEl = addressDetailsEl.find(".card-header .menu-col .export-address");
        var addMyAddressesEl = addressDetailsEl.find(".card-header .menu-col .add-to-my-addresses");
        var removeMyAddressesEl = addressDetailsEl.find(".card-header .menu-col .remove-from-my-addresses");


        var transactionListPaginationEl = transactionListEl.find(".pagination");

        var transactionListStartEl = transactionListPaginationEl.find(".pagination-start");
        transactionListStartEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            LoadAddressTxInfo(_address.txCount);
            return false;
        });

        var transactionListNextEl = transactionListPaginationEl.find(".pagination-next");
        transactionListNextEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            LoadAddressTxInfo(_currentTransactionPos + _transactionPerPage);
            return false;
        });

        var transactionListPreviousEl = transactionListPaginationEl.find(".pagination-previous");
        transactionListPreviousEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            LoadAddressTxInfo(_currentTransactionPos - _transactionPerPage);
            return false;
        });

        var transactionListEndEl = transactionListPaginationEl.find(".pagination-end");
        transactionListEndEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            LoadAddressTxInfo(_address.txCount < _transactionPerPage ? _address.txCount : _transactionPerPage);
            return false;
        });


        addMyAddressesEl.click(function(){
            var name = prompt("Please enter a name for the address");
            if (name == null) return;

            sendWalletWorkerRequest({
                op:"createAddress",
                name:name,
                address: _address.address
            });
            return;
        });


        removeMyAddressesEl.click(function(){
            if (confirm("Are you sure?") == false) return;
        
            sendWalletWorkerRequest({
                op:"deleteAddress",
                address: _address.address
            });
            return;
        });

        menuButtonEl.click(function(){
            sendWalletWorkerRequest({
                op:"getAddress",
                address: _address.address
            }).then(function(response){

                if (response.data != null)
                {
                    addMyAddressesEl.addClass("disabled");
                    removeMyAddressesEl.removeClass("disabled");
                }
                else{
                    addMyAddressesEl.removeClass("disabled");
                    removeMyAddressesEl.addClass("disabled");
                }
            });
        });


        var loadAddress = function (addressId) {
            _addressId = addressId;

            addressEl.text(addressId);
                
            sentEl.text("");
            receivedEl.text("");
            balanceEl.text("");
            transactionRowsEl.empty();

            var promise = null;
            if (canSendWebsocketRequest())
            {
                var request = {
                    op:"getAddress",
                    address: addressId
                }
                promise = sendWebsocketRequest(request).then(function(result){
                    return result.data;
                });
            }
            else
            {
                promise = $.get(chaincoinBlockchainApiUrl + "/getAddress?address=" + addressId);
            }


            promise.then(function (address) {
                
                _address = address;
                sentEl.text(_address.sent);
                receivedEl.text(_address.received);
                balanceEl.text(_address.balance);
                
                
                LoadAddressTxInfo(_address.txCount);
                
            });
        }

        var processPaginationControls = function(){

            if (_currentTransactionPos == _address.txCount){
                transactionListStartEl.children().addClass("paginationDisabled");
                transactionListNextEl.children().addClass("paginationDisabled");
            }
            else
            {
                transactionListStartEl.children().removeClass("paginationDisabled");
                transactionListNextEl.children().removeClass("paginationDisabled");
            }

            if (_currentTransactionPos <= _transactionPerPage){
                transactionListPreviousEl.children().addClass("paginationDisabled");
                transactionListEndEl.children().addClass("paginationDisabled");
            }
            else
            {
                transactionListPreviousEl.children().removeClass("paginationDisabled");
                transactionListEndEl.children().removeClass("paginationDisabled");
            }
        };


        var LoadAddressTxInfo = function (startTransaction) {

           
            

            var rowPromises = [];



            var rowsPromise = null;
            if (canSendWebsocketRequest())
            {
                var request = {
                    op:"getAddressTxs",
                    address: _address.address,
                    pos: startTransaction,
                    pageSize: startTransaction < _transactionPerPage ? startTransaction : _transactionPerPage
                }
                rowsPromise = sendWebsocketRequest(request).then(function(result){
                    return result.data;
                });
            }
            else
            {
                rowsPromise = $.get(chaincoinBlockchainApiUrl + "/getAddressTxs?address=" + _address.address + "&pos=" + startTransaction + "&pageSize=" + _transactionPerPage).then(function(addressTxInfo){return addressTxInfo;});
            }

            rowsPromise.then(function (addressTxs) {

                transactionRowsEl.empty();
                
                for (var i = 0; i < addressTxs.length; i++) {
                    var transationRowEl = transactionRowTemplateEl.clone().appendTo(transactionRowsEl);
                    
                    var timestamp = new Date(addressTxs[i].time * 1000);
                    transationRowEl.find(".timestamp-col").text(timestamp.toLocaleTimeString() + " " + timestamp.toLocaleDateString());

                    
                    var anchorEl = $('<a href="#Explorer/Transaction/' + addressTxs[i].txid + '" />');

                    transationRowEl.find(".hash-col").text("");
                    var hashAnchorEl = anchorEl.clone().appendTo(transationRowEl.find(".hash-col"));
                    hashAnchorEl.text(addressTxs[i].txid);

                    
                    transationRowEl.find(".amount-col").text(addressTxs[i].value);
                }


                _currentTransactionPos = startTransaction;
                processPaginationControls();
            }).always(function () {
               
            });
        };


        

        exportAddressEl.click(function(){


            var pageSize = 100;
            
            var getNext = function(pos, fileData){
                if (fileData == null) fileData = "Transaction,type, pos, Date Time, Amount\r\n";
                

                var request = {
                    op:"getAddressTxs",
                    address: _address.address,
                    pos: pos,
                    pageSize: pageSize > pos ? pos : pageSize
                }

                return sendRequest(request).then(function(txs){
                    for(var i = 0; i < txs.length; i++)
                    {
                        var timestamp = new Date(txs[i].time * 1000);

                        
                        var rowData = txs[i].txid + "," + txs[i].type + "," + (txs[i].type == "vin" ? txs[i].vin: txs[i].vout) + "," + timestamp.toLocaleTimeString() + " " + timestamp.toLocaleDateString() + "," + txs[i].value + "\r\n";
                        fileData = fileData + rowData;
                    }

                    if (pos > pageSize) return getNext(pos - pageSize, fileData);
                    else return fileData;
                });
            };


            getNext(_address.txCount).then(function(fileData){
                download(_address.address + ".csv", fileData);
            });


        });

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

    });
</script>



<style>

.address-download-link {
    float: right;
    font-size: 20px;
}

.address-download-link .fa-download{
    cursor: pointer;
    color: #007bff;
}

.address-download-link .fa-download:hover{
    color: #0056b3;
}
    
</style>