<div class="BlocksTable" >


    <div class="card block-table-card">
        <div class="card-header">
            Blocks
        </div>
        <div class="card-body">
            <div class="BlocksTable-content">
                <div class="center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            <li class="page-item pagination-start">
                                <a class="page-link" href="#">&lt;&lt;</a>
                            </li>
                            <li class="page-item pagination-previous">
                                <a class="page-link" href="#">&lt;</a>
                            </li>
                            <li class="page-item pagination-next">
                                <a class="page-link" href="#">&gt;</a>
                            </li>
                            <li class="page-item pagination-end">
                                <a class="page-link" href="#">&gt;&gt;</a>
                            </li>
                        </ul>
                    </nav>
                </div>

                <div class="row header">
                    <div class="col-lg-1 block-col">
                        Block
                    </div>

                    <div class="col-lg-5 hash-col">
                        Hash
                    </div>

                    <div class="col-lg-1 recipients-col">
                        Recipients
                    </div>

                    <div class="col-lg-2 amount-col">
                        Amount (CHC)
                    </div>
                    <div class="col-lg-2 timestamp-col">
                        Timestamp
                    </div>

                    <div class="col-lg-1 version-bits-col">
                        Version Bits
                    </div>

                </div>

                <div class="rows">

                </div>


                <div class="center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            <li class="page-item pagination-start">
                                <a class="page-link" href="#">&lt;&lt;</a>
                            </li>
                            <li class="page-item pagination-previous">
                                <a class="page-link" href="#">&lt;</a>
                            </li>
<!--
                            <li class="page-item pagination-skip-11">
                                <a class="page-link" href="#">11</a>
                            </li>
                            <li class="page-item pagination-skip-10">
                                <a class="page-link" href="#">10</a>
                            </li>
                            <li class="page-item pagination-skip-9">
                                <a class="page-link" href="#">9</a>
                            </li>
                            <li class="page-item pagination-skip-8">
                                <a class="page-link" href="#">8</a>
                            </li>
                            <li class="page-item pagination-skip-7">
                                <a class="page-link" href="#">7</a>
                            </li>
                            <li class="page-item pagination-skip-6">
                                <a class="page-link" href="#">6</a>
                            </li>
                            <li class="page-item pagination-skip-5">
                                <a class="page-link" href="#">5</a>
                            </li>
                            <li class="page-item pagination-skip-4">
                                <a class="page-link" href="#">4</a>
                            </li>
                            <li class="page-item pagination-skip-3">
                                <a class="page-link" href="#">3</a>
                            </li>
                            <li class="page-item pagination-skip-2">
                                <a class="page-link" href="#">2</a>
                            </li>
                            <li class="page-item pagination-skip-1">
                                <a class="page-link" href="#">1</a>
                            </li>-->
                            <li class="page-item pagination-next">
                                <a class="page-link" href="#">&gt;</a>
                            </li>
                            <li class="page-item pagination-end">
                                <a class="page-link" href="#">&gt;&gt;</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>

            <div class="loader-container">
                <div class="loader">

                </div>
            </div>
        </div>
    </div>


    <div class="card block-notifications-card">
        <div class="card-header">
            Notifications
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-sm-4">
                    Enabled Push Notification
                </div>
                <div class="col-sm-4">
                    <input type="checkbox" class="push-notification-enabled">
                </div>
            </div>

            <div class="row">
                <div class="col-sm-4">
                    New Block
                </div>
                <div class="col-sm-4">
                    <input type="checkbox" class="new-block-notification">
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    $(function () {

        var loaded = false;


        $("body").on("blockCount", function (event, getBlockCount) {
            blockCount = getBlockCount;

            processPaginationControls();
        });

        $(".BlocksTable").on("showArea", function () {
            
            if (blockCount == null)
            {
                var promise = jQuery.Deferred();
                $("body").trigger("getBlockCount",[promise]);

                promise.then(function(getBlockCount){
                    blockCount = getBlockCount;
                    BlocksTableLoadBlock(blockCount);
                });
            }
            else 
            {
                BlocksTableLoadBlock(blockCount);
            }
        });




        var blockCount = null;
        var blockTableEl = $(".BlocksTable");
        var blockTableCardEl = blockTableEl.find(".block-table-card");
        var rowUiTemplate = blockTableCardEl.find(".header").clone().removeClass("header");
        var rowsUi = blockTableCardEl.find(".rows");



        var currentBlockId = 0;
        var blockTableRowsPerPage = 20;

        var blockTablePaginationEl = $(".BlocksTable .pagination");
        var blockTablePaginationStartEl = blockTablePaginationEl.find(".pagination-start");
        blockTablePaginationStartEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            BlocksTableLoadBlock(blockCount);
            return false;
        });

        var blockTablePaginationPreviousEl = blockTablePaginationEl.find(".pagination-previous");
        blockTablePaginationPreviousEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            BlocksTableLoadBlock(currentBlockId + blockTableRowsPerPage);
            return false;
        });

        var blockTablePaginationNextEl = blockTablePaginationEl.find(".pagination-next");
        blockTablePaginationNextEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            BlocksTableLoadBlock(currentBlockId - blockTableRowsPerPage);
            return false;
        });


        

        var blockTablePaginationEndEl = blockTablePaginationEl.find(".pagination-end");
        blockTablePaginationEndEl.click(function () {
            if ($(this).children().hasClass("paginationDisabled")) return false;

            if (currentBlockId % blockTableRowsPerPage == 0) BlocksTableLoadBlock(blockTableRowsPerPage);
            else BlocksTableLoadBlock(currentBlockId % blockTableRowsPerPage);
            
            return false;
        });

        var paginationSkipControls = [];
        var paginationSkip = 1;
        while(blockTablePaginationEl.find(".pagination-skip-" + paginationSkip).length != 0)
        {
            paginationSkipControls.push(blockTablePaginationEl.find(".pagination-skip-" + paginationSkip));
            paginationSkip++;
        }


        var processPaginationControls = function(){

            if (currentBlockId == blockCount){
                blockTablePaginationStartEl.children().addClass("paginationDisabled");
                blockTablePaginationPreviousEl.children().addClass("paginationDisabled");
            }
            else
            {
                blockTablePaginationStartEl.children().removeClass("paginationDisabled");
                blockTablePaginationPreviousEl.children().removeClass("paginationDisabled");
            }

            if (currentBlockId <= blockTableRowsPerPage){
                blockTablePaginationNextEl.children().addClass("paginationDisabled");
                blockTablePaginationEndEl.children().addClass("paginationDisabled");
            }
            else
            {
                blockTablePaginationNextEl.children().removeClass("paginationDisabled");
                blockTablePaginationEndEl.children().removeClass("paginationDisabled");
            }

           // debugger;

            //var pageCount = Math.ceil(blockCount / blockTableRowsPerPage);
           // var currentPage = Math.ceil(currentBlockId / blockTableRowsPerPage);

           
           
/*
            var middle = Math.ceil(paginationSkipControls.length/2);

            var skipStartBlockId = currentBlockId + (middle * blockTableRowsPerPage);

            if (skipStartBlockId > blockCount)
            {
                skipStartBlockId = blockCount;
            }
            else if (skipStartBlockId  - (paginationSkipControls.length * blockTableRowsPerPage) < 0)
            {
                skipStartBlockId = paginationSkipControls.length * blockTableRowsPerPage;
            }

            for(var i = 0; i < paginationSkipControls.length; i++)
            {
                var paginationSkipControl = paginationSkipControls[(paginationSkipControls.length - 1) - i];
                
                let skipBlockId = skipStartBlockId - (i * blockTableRowsPerPage);

                var page = Math.ceil(skipBlockId / blockTableRowsPerPage);
                
                paginationSkipControl.children().text(page + "");
                paginationSkipControl.unbind("click");
                paginationSkipControl.bind("click", function(){
                    BlocksTableLoadBlock(skipBlockId)
                });
            }*/
        }


        var BlocksTableLoadBlock = function (startBlockId) {


            if (startBlockId > blockCount) startBlockId = blockCount;

            
            blockTableCardEl.addClass("loading");


            var request = {
                op:"getBlocks",
                blockId: startBlockId,
                pageSize: blockTableRowsPerPage < startBlockId ? blockTableRowsPerPage : startBlockId,
                extended:true
            }

            sendRequest(request).then(function(blocks){

                rowsUi.empty();
                for (var i = 0; i < blocks.length; i++) {
                    var rowUi = rowUiTemplate.clone().appendTo(rowsUi);

                    rowUi.addClass("row-striped");

                    var anchorEl = $('<a href="#Explorer/Block/' + blocks[i].height + '" />');

                    rowUi.find(".block-col").text("");
                    var blockAnchorEl = anchorEl.clone().appendTo(rowUi.find(".block-col"));
                    blockAnchorEl.text(blocks[i].height);

                    rowUi.find(".hash-col").text("");
                    var hashAnchorEl = anchorEl.clone().appendTo(rowUi.find(".hash-col"));
                    hashAnchorEl.text(blocks[i].hash);


                    if (blocks[i].extended)
                    {
                        var recipientCount = 0;
                        var blockValue = 0;

                        blocks[i].tx.forEach(function (tx) {

                            blockValue = blockValue + tx.value;
                            recipientCount = recipientCount + tx.recipients;
                        });

                        rowUi.find(".recipients-col").text(recipientCount);
                        rowUi.find(".amount-col").text(blockValue);
                    }
                    else{
                        rowUi.find(".recipients-col").text("");
                        rowUi.find(".amount-col").text("");
                    }
                    


                    var timestamp = new Date((blocks[i].time * 1000));
                    rowUi.find(".timestamp-col").text(timestamp.toLocaleTimeString() + " " + timestamp.toLocaleDateString());
                    
                    var versionBits = [];
                    if (((blocks[i].version >> 29) & 7) == 1)
                    {
                        for(var bit = 0; bit < 28; bit++)
                        {
                            if ((blocks[i].version >> bit) & 1 == 1)
                            {
                                versionBits.push(bit);
                            }
                        }
                    }   
                    rowUi.find(".version-bits-col").text(versionBits.join(", "));
                     
                }  

                currentBlockId = startBlockId;
                processPaginationControls();

            }).always(function () {
                blockTableCardEl.removeClass("loading");
            });
        };

    });


    $(function(){


        var load = function(){
            $.get( location.protocol + "//notifications" + chaincoinApiDomain + "/isBlockSubscription?firebaseId=" + encodeURI(deviceToken), function( data ) {
                newBlockNotificationEl.prop("checked",data);
            });
        }
        

        var blockTableEl = $(".BlocksTable");

        $("body").on("PushedNotificationEnabled",function(){
            newBlockNotificationEl.attr("disabled", false);
            load();
        });
        $("body").on("PushedNotificationDisabled",function(){
            newBlockNotificationEl.attr("disabled", true);
        });

        blockTableEl.on("showArea", function () {
            if (deviceToken != null) load();
        });


        var blockNotificationsCardEl = blockTableEl.find(".block-notifications-card");

        var pushNotificationEnabledEl = blockNotificationsCardEl.find(".push-notification-enabled");
        var newBlockNotificationEl = blockNotificationsCardEl.find(".new-block-notification");
        

       
        setupEnabledPushNotificationCheckbox(pushNotificationEnabledEl);

        

        if (deviceToken == null) newBlockNotificationEl.attr("disabled", true);

        newBlockNotificationEl.change(function(){

            if (newBlockNotificationEl.prop("checked"))
            {
                $.get( location.protocol + "//notifications" + chaincoinApiDomain + "/saveBlockSubscription?firebaseId=" + encodeURI(deviceToken))
                .done(function(data){
                })
                .fail(function(){
                    alert("an error occurred");
                    newBlockNotificationEl.prop("checked",false);
                });
            }
            else
            {
                $.get( location.protocol + "//notifications" + chaincoinApiDomain + "/deleteBlockSubscription?firebaseId=" + encodeURI(deviceToken))
                .done(function(data){
                })
                .fail(function(){
                    alert("an error occurred");
                    newBlockNotificationEl.prop("checked",true);
                });
            }
            
        });


    });

</script>


<style>

    


    .BlocksTable .panel-body {
        position: relative;
    }

    .block-table-card.loading .BlocksTable-content {
        position: relative;
        opacity: 0.2;
    }

    .block-table-card .loader-container {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        display: none;

    }

    .block-table-card.loading .loader-container {
        display: block;
    }




</style>