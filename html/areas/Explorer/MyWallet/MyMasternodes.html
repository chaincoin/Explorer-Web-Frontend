<div class="my-masternodes-area" >

    <div class="card my-masternodes-card">
        <div class="card-header">
            My Masternodes
        </div>
        <div class="card-body">


            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active myMasternodesTab" data-toggle="tab" href="#myMasternodesTabData" role="tab" aria-selected="true">Details</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link myMasternodesGraphTab" data-toggle="tab" href="#myMasternodesGraphTabData" role="tab" aria-selected="false">Graph</a>
                </li>
            </ul>
                
            <div class="tab-content">
                
                <div class="tab-pane fade show active" id="myMasternodesTabData" role="tabpanel">
                    <button type="button" class="btn btn-primary add-my-masternode">Add Masternode</button>
                    <div class="my-masternode-table-content">
                        <div class="center" style="display: none;">
                            <nav aria-label="Page navigation example">
                                <ul class="pagination">
                                    <li class="page-item pagination-start">
                                        <a class="page-link" href="#">&lt;&lt;</a>
                                    </li>
                                    <li class="page-item pagination-previous">
                                        <a class="page-link" href="#">&lt;</a>
                                    </li>
                                    <li class="page-item pagination-next">
                                        <a class="page-link" href="#">&gt;</a>
                                    </li>
                                    <li class="page-item pagination-end">
                                        <a class="page-link" href="#">&gt;&gt;</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                        
                        <div class="row header">
                            <div class="col-sm-1 status-icon-col">
                                <span class="status-icon"></span>
                            </div>
                            <div class="col-lg-2 name-col">
                                Name
                            </div>
                            <div class="col-lg-2 status-col">
                                Status
                            </div>
                            <div class="col-lg-2 lastseen-col">
                                Last Seen
                            </div>
                            <div class="col-lg-2 lastpaidtime-col">
                                Last Paid
                            </div>
                            <div class="col-lg-2 controls-col">
                                <button type="button" class="btn btn-danger my-masternode-action-delete">Delete</button>
                            </div>
                        </div>
        
                        <div class="rows">
        
                        </div>
        
        
                        <div class="center" style="display: none;">
                            <nav aria-label="Page navigation example">
                                <ul class="pagination">
                                    <li class="page-item pagination-start">
                                        <a class="page-link" href="#">&lt;&lt;</a>
                                    </li>
                                    <li class="page-item pagination-previous">
                                        <a class="page-link" href="#">&lt;</a>
                                    </li>
        
                                    <li class="page-item pagination-next">
                                        <a class="page-link" href="#">&gt;</a>
                                    </li>
                                    <li class="page-item pagination-end">
                                        <a class="page-link" href="#">&gt;&gt;</a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>

                </div>
                
                <div class="tab-pane fade" id="myMasternodesGraphTabData" role="tabpanel" aria-labelledby="myMasternodesGraphTabData">
                    <div class="form-group">
                        <label>Unit:</label>
                        <select class="form-control mnPayoutsGraphUnit">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected="selected">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Value:</label>
                        <select class="form-control mnPayoutsGraphValue">
                            <option value="sum" selected="selected">CHC</option>
                            <option value="count">Count</option>
                        </select>
                    </div>
                    <canvas class="mnPayoutsGraph"></canvas>
                </div>

                
            </div>


            

            
        </div>
    </div>

</div>



<script>
$(function(){

    var myMasternodesAreaEl = $(".my-masternodes-area");


    myMasternodesAreaEl.on("showArea", function () {
        loadMyMasternodes();
        debugger;
    });


    var myMasternodesCardEl = myMasternodesAreaEl.find(".my-masternodes-card");
    var myMasternodesRowTemplateEl = myMasternodesCardEl.find(".header").clone().removeClass("header").addClass("row-striped");
    var myMasternodesRowsEl = myMasternodesCardEl.find(".rows");

    var addMyMasternodeEl = myMasternodesCardEl.find(".add-my-masternode");

    addMyMasternodeEl.click(function(){
        var name = prompt("Please enter a name for the masternode");
        if (name == null) return;

        var output = prompt("Please enter the masternode output");
        if (output == null) return;


        if (/^[a-fA-F0-9]{64}-[0-9]{1,8}$/.test(output) == false){
            alert("invalid masternode output");
            return;
        }

        sendWalletWorkerRequest({
            op:"createMasternode",
            name:name,
            output: output
        }).then(loadMyMasternodes);
    });
    


    var loadMyMasternodes = function(){

        var myMasternodesPromise = sendWalletWorkerRequest({
            op:"listMasternodes"
        });


        
        var masternodeListPromise = sendRequest({
                op:"getMasternodeList",
                extended:true
        });

        Promise.all([myMasternodesPromise, masternodeListPromise]).then(function(values) {

            debugger;
            myMasternodesRowsEl.empty();

            var myMasternodes = values[0].data;
            var masternodeList = values[1];

            for(var i = 0; i < myMasternodes.length; i++)
            {
                let myMasternode = myMasternodes[i];
                let masternode = masternodeList[myMasternode.output];

                let myMasternodesRowEl = myMasternodesRowTemplateEl.clone();

                var statusIconEl = myMasternodesRowEl.find(".status-icon");
                if (masternode != null && (masternode.status == "ENABLED" || masternode.status == "PRE_ENABLED")) statusIconEl.addClass("fa fa-check");
                else statusIconEl.addClass("fa fa-times");
                
                
                var nameColumnEl = myMasternodesRowEl.find(".name-col")
                if(masternode != null) nameColumnEl.text("").append($('<a href="#Explorer/MasternodeList/' + myMasternode.output + '" />').text(myMasternode.name));
                else nameColumnEl.text(myMasternode.name);


                if (masternode != null)
                {
                    myMasternodesRowEl.find(".status-col").text(masternode.status);

                    var lastseenTimestamp = new Date((masternode.lastseen * 1000));
                    myMasternodesRowEl.find(".lastseen-col").text(lastseenTimestamp.toLocaleTimeString() + " " + lastseenTimestamp.toLocaleDateString());

                    var lastpaidTimestamp = new Date((masternode.lastpaidtime * 1000));
                    myMasternodesRowEl.find(".lastpaidtime-col").text(lastpaidTimestamp.toLocaleTimeString() + " " + lastpaidTimestamp.toLocaleDateString());
                }
                else
                {
                    myMasternodesRowEl.find(".status-col").text("Not Found");
                    myMasternodesRowEl.find(".lastseen-col").text("");
                    myMasternodesRowEl.find(".lastpaidtime-col").text("");
                }

                myMasternodesRowEl.find(".my-masternode-action-delete").click(function(){

                    if (confirm("Are you sure?") == false) return;
                    
                    sendWalletWorkerRequest({
                        op:"deleteMasternode",
                        output:myMasternode.output
                    }).then(function(){
                        myMasternodesRowEl.remove();
                    });
                });

                myMasternodesRowsEl.append(myMasternodesRowEl);

            }
        
        });

    }


    var myMasternodesGraphTabEl = myMasternodesCardEl.find(".myMasternodesGraphTab");

    var myMasternodesGraphTabData= myMasternodesCardEl.find("#myMasternodesGraphTabData");
    var mnPayoutsGraphUnitEl = myMasternodesGraphTabData.find(".mnPayoutsGraphUnit");
    var mnPayoutsGraphValueEl = myMasternodesGraphTabData.find(".mnPayoutsGraphValue");
    var mnPayoutsGraphEl = myMasternodesGraphTabData.find(".mnPayoutsGraph");


    var mnPayOutsGraph = null;
    var mnPayOutsLineColours = [
        "rgb(230, 25, 75)", "rgb(60, 180, 75)", "rgb(255, 225, 25)", 
        "rgb(0, 130, 200)", "rgb(245, 130, 48)", "rgb(145, 30, 180)", 
        "rgb(70, 240, 240)", "rgb(240, 50, 230)", "rgb(210, 245, 60)", 
        "rgb(250, 190, 190)", "rgb(0, 128, 128)", "rgb(230, 190, 255)", 
        "rgb(170, 110, 40)", "rgb(255, 250, 200)", "rgb(128, 0, 0)", 
        "rgb(170, 255, 195)", "rgb(128, 128, 0)", "rgb(255, 215, 180)", 
        "rgb(0, 0, 128)", "rgb(128, 128, 128)", "rgb(0, 0, 0)"];

    var color = Chart.helpers.color;
    var config = {
        type: 'line',
        data: {
            datasets: []
        },
        options: {
            title: {
                text: 'Maternode Payouts'
            },
            scales: {
                xAxes: [{
                    type: 'time',
                    time: {
                        unit: 'week'
                    }
                }],
                yAxes: [{
                    scaleLabel: {
                        display: true,
                        labelString: 'Payouts'
                    }
                }]
            },
        }
    };

    myMasternodesGraphTabEl.click(function(){
        loadGraph();
    });

    mnPayoutsGraphUnitEl.change(function(){
        loadGraph();
    });

    mnPayoutsGraphValueEl.change(function(){
        loadGraph();
    });

    var loadGraph = function(){
        debugger;


        if (mnPayoutsGraphUnitEl.val() == "daily") config.options.scales.xAxes[0].time.unit = "day";
        if (mnPayoutsGraphUnitEl.val() == "weekly") config.options.scales.xAxes[0].time.unit = "week";
        if (mnPayoutsGraphUnitEl.val() == "monthly") config.options.scales.xAxes[0].time.unit = "month";
        if (mnPayoutsGraphUnitEl.val() == "yearly") config.options.scales.xAxes[0].time.unit = "year";
        
        var myMasternodesPromise = sendWalletWorkerRequest({
            op:"listMasternodes"
        });


        
        var masternodeListPromise = sendRequest({
                op:"getMasternodeList",
                extended:true
        });

        Promise.all([myMasternodesPromise, masternodeListPromise]).then(function(values) {

            debugger;


            var myMasternodes = values[0].data;
            var masternodeList = values[1];

            var mnPayOutStatsPromises = [];

            for(var i = 0; i < myMasternodes.length; i++)
            {
                let myMasternode = myMasternodes[i];
                let masternode = masternodeList[myMasternode.output];

                if (masternode == null) continue;

                var mnPayOutStatsPromise = sendRequest({
                    op: "getPayoutStats",
                    address: masternode.payee,
                    type:"masternode",
                    unit: mnPayoutsGraphUnitEl.val()
                }).then(function(payOutStats){
                    return {
                        myMasternode: myMasternode,
                        masternode: masternode,
                        payOutStats: payOutStats
                    }
                });

                mnPayOutStatsPromises.push(mnPayOutStatsPromise);
            }

            return Promise.all(mnPayOutStatsPromises);
        }).then(function(mnPayOutStats){

            
            config.data.datasets = [];


            mnPayOutStats.forEach(function(mnPayOutStat, mnPayOutStatPos){
                var dataset = {
                    label: mnPayOutStat.myMasternode.name,
                    backgroundColor: color(mnPayOutsLineColours[mnPayOutStatPos % mnPayOutsLineColours.length]).alpha(0.5).rgbString(),
                    borderColor: mnPayOutsLineColours[mnPayOutStatPos % mnPayOutsLineColours.length],
                    fill: false,
                    data: [],
                }

                var lastDate = null;
                for(var i = 0; i < mnPayOutStat.payOutStats.length; i++)
                {
                    var stat = mnPayOutStat.payOutStats[i];
                    var date = null;
                    

                    if (mnPayoutsGraphUnitEl.val() == "daily") date = new Date(stat._id.year, stat._id.month - 1, stat._id.day);
                    if (mnPayoutsGraphUnitEl.val() == "weekly") {
                        date = new Date(stat._id.year, 0, 1);
                        date.setDate(stat._id.week * 7);
                    }
                    if (mnPayoutsGraphUnitEl.val() == "monthly") date = new Date(stat._id.year, stat._id.month - 1, 1);
                    if (mnPayoutsGraphUnitEl.val() == "yearly") date = new Date(stat._id.year, 0, 1);

                    if (lastDate != null)
                    {
                        var current = new Date(lastDate.getTime());

                        if (mnPayoutsGraphUnitEl.val() == "daily") current.setDate(current.getDate() + 1);
                        if (mnPayoutsGraphUnitEl.val() == "weekly") current.setDate(current.getDate() + 7);
                        if (mnPayoutsGraphUnitEl.val() == "monthly") current.setMonth(current.getMonth() + 1);
                        if (mnPayoutsGraphUnitEl.val() == "yearly") current.setFullYear(current.getFullYear() + 1);

                        


                        while(current < date){
                            dataset.data.push({
                                x: current,
                                y: 0
                            });

                            current = new Date(current.getTime());
                            if (mnPayoutsGraphUnitEl.val() == "daily") current.setDate(current.getDate() + 1);
                            if (mnPayoutsGraphUnitEl.val() == "weekly") current.setDate(current.getDate() + 7);
                            if (mnPayoutsGraphUnitEl.val() == "monthly") current.setMonth(current.getMonth() + 1);
                            if (mnPayoutsGraphUnitEl.val() == "yearly") current.setFullYear(current.getFullYear() + 1);
                        }
                    }

                    dataset.data.push({
                        x: date,
                        y: mnPayoutsGraphValueEl.val() == "sum" ? stat.value : stat.count
                    });

                    lastDate = date;
                }

                config.data.datasets.push(dataset);
                
            });

           /* var totalDataset = {
                label: mnPayOutStat.myMasternode.name,
                backgroundColor: color(mnPayOutsLineColours[mnPayOutStats % mnPayOutsLineColours.length]).alpha(0.5).rgbString(),
                borderColor: mnPayOutsLineColours[mnPayOutStats % mnPayOutsLineColours.length],
                fill: false,
                data: [],
            }

            config.data.datasets.forEach(function(mnPayOutStat){

            });*/

            if (mnPayOutsGraph == null)
            {
                var ctx = mnPayoutsGraphEl[0].getContext('2d');
                mnPayOutsGraph = new Chart(ctx, config);
            }
            else
            {
                mnPayOutsGraph.update();
            }
            

        });
    }

});




</script>



<style>


    .my-masternodes-card .my-masternodes-table-content {
        position: relative;
        opacity: 0.2;
    }

    .my-masternodes-card .loader-container {
        position: absolute;
        top: 0px;
        bottom: 0px;
        left: 0px;
        right: 0px;
        display: none;

    }

    .my-masternodes-card.loading .loader-container {
        display: block;
    }

    .my-masternodes-card .header .controls-col{
        visibility: hidden;
    }

    .my-masternodes-card .status-icon-col .status-icon{
        font-size: 25px;
    }
    
    .my-masternodes-card .status-icon-col .status-icon.fa-check{
        color:lawngreen;
    }

    .my-masternodes-card .status-icon-col .status-icon.fa-times{
        color:red;
    }

</style>    